<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>網頁扭蛋抽獎</title>
<style>
body { font-family: Arial, sans-serif; text-align:center; margin:0; padding:0; }
button { padding:10px 20px; font-size:16px; cursor:pointer; }
.page { display:none; padding:20px; }
img { max-width:100%; height:auto; }
#draw-result { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); color:#fff; display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:2em; }
#draw-result button { margin-top:20px; }
</style>
</head>
<body>

<!-- 封面頁 -->
<div id="cover" class="page" style="display:block;">
  <h1>歡迎來到扭蛋抽獎！</h1>
  <img src="https://via.placeholder.com/300x200?text=封面圖" alt="封面圖">
  <br><br>
  <button onclick="gotoCodePage()">進入抽獎</button>
</div>

<!-- 驗證碼頁 -->
<div id="code-page" class="page">
  <h2>請輸入驗證碼</h2>
  <input type="text" id="code-input" maxlength="4">
  <button onclick="verifyCode()">確認</button>
  <p id="code-msg" style="color:red;"></p>
</div>

<!-- 抽獎頁 -->
<div id="draw-page" class="page">
  <h2>扭蛋機抽獎</h2>
  <img src="https://via.placeholder.com/200x300?text=扭蛋機" alt="扭蛋機">
  <br><br>
  <button onclick="draw()">抽獎</button>
  <p id="status"></p>
</div>

<!-- 抽中結果 -->
<div id="draw-result" style="display:none;">
  <div id="prize-name"></div>
  <button onclick="closeResult()">再抽一次</button>
</div>

<audio id="sound" src="https://www.soundjay.com/button/beep-07.wav"></audio>

<script>
let currentCode = null;

// 頁面切換
function showPage(id) {
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  document.getElementById(id).style.display='block';
}

// 封面 → 驗證碼頁
function gotoCodePage() {
  showPage('code-page');
}

// 驗證碼確認
async function verifyCode() {
  const code = document.getElementById('code-input').value;
  const res = await fetch('http://localhost:3000/api/verify',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({code})
  });
  const data = await res.json();
  if(data.valid) {
    currentCode = code;
    showPage('draw-page');
    updateStatus();
  } else {
    document.getElementById('code-msg').innerText = "驗證碼無效或已使用";
  }
}

// 抽獎
async function draw() {
  if(!currentCode) return;
  const res = await fetch('http://localhost:3000/api/draw',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({code:currentCode})
  });
  const data = await res.json();
  if(data.success) {
    document.getElementById('prize-name').innerText = `恭喜你抽到: ${data.prize}`;
    document.getElementById('draw-result').style.display='flex';
    document.getElementById('sound').play();
    updateStatus(data.remaining);
  } else {
    alert(data.msg);
  }
}

// 關閉抽中結果 → 回到抽獎頁
function closeResult() {
  document.getElementById('draw-result').style.display='none';
}

// 更新抽獎剩餘狀態
function updateStatus(remaining=null) {
  if(remaining){
    const status = remaining.map(p=>`${p.name}:${p.remaining}`).join(' | ');
    document.getElementById('status').innerText = "剩餘數量：" + status;
  }
}

</script>

</body>
</html>
